networks:
  db:
    # Ensure the network is created by this compose file the first time we run it
    external: false
    name: db
services:
  db:
    container_name: db
    build:
      context: .
      dockerfile: Dockerfile
    image: keithmoss/postgres-pgbackrest:15
    restart: always
    command: postgres -c 'config_file=/etc/postgresql/postgresql.conf'
    ports:
      - "5432:5432"
    networks:
      - db
    env_file:
      - secrets/db.env
    volumes:
      - ./data:/var/lib/postgresql/data
      - ./logs/postgresql:/etc/postgresql/pg_log
      # Enable this mapping to inject the tweaked postgresql.conf file into our PostgreSQL container.
      - ./postgresql.conf:/etc/postgresql/postgresql.conf
      # Mount pgBackRest log directory for easier access
      - ./logs/pgbackrest:/var/log/pgbackrest
      # Credential wrapper for pgBackRest (loads AWS keys before executing)
      - ./pgbackrest-wrapper.sh:/usr/local/bin/pgbackrest-wrapper:ro
    secrets:
      # AWS credentials for pgBackRest S3 backups
      # Loaded by pgbackrest-wrapper-container.sh before executing backups/restores
      - aws.env

secrets:
  aws.env:
    file: ../backups/secrets/aws.env
